<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Neon Audio Visualizer â€¢ Crypto Evolution</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg: #070910; --panel: rgba(14,16,26,0.55); --panel-2: rgba(14,16,26,0.75);
      --text: #e7eeff; --muted:#9fb2ffcc; --accent:#7c4dff; --accent2:#00e5ff;
      --glow: 0 0 22px rgba(124,77,255,.45), 0 0 60px rgba(0,229,255,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
      background: radial-gradient(1100px 800px at 70% 15%, #12172a 0%, #0b0f1e 42%, #070910 100%);
      overflow:hidden}
    /* WebGL background */
    #bg{position:fixed; inset:0; z-index:0}
    canvas.webgl{width:100%; height:100%; display:block}

    /* Foreground layout */
    .shell{position:relative; z-index:5; min-height:100%; display:grid; grid-template-rows:auto 1fr auto}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between; padding:16px 18px; backdrop-filter:blur(10px); background:linear-gradient(180deg, rgba(7,9,16,.75), rgba(7,9,16,.25)); border-bottom:1px solid rgba(255,255,255,.06)}
    .brand{display:flex; align-items:center; gap:12px}
    .dot{width:12px; height:12px; border-radius:50%; background:linear-gradient(135deg,var(--accent),var(--accent2)); box-shadow:var(--glow)}
    .brand b{font-size:18px; letter-spacing:.3px}
    .brand small{opacity:.7}

    .controls{display:flex; align-items:center; gap:10px; background:var(--panel); border:1px solid rgba(255,255,255,.08); padding:8px 10px; border-radius:14px; box-shadow:var(--glow)}
    button{appearance:none; border:1px solid rgba(255,255,255,.08); background:linear-gradient(180deg,#1e2340,#14182d); color:var(--text); padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; transition:.12s ease}
    button:hover{transform:translateY(-1px); box-shadow:0 10px 26px rgba(124,77,255,.25)}
    .accent{background:linear-gradient(135deg, rgba(124,77,255,.9), rgba(0,229,255,.9))}
    input[type="range"]{accent-color:#9ecbff}

    .marquee{display:flex; align-items:center; gap:10px; overflow:hidden; mask-image:linear-gradient(90deg,transparent,#000 10%,#000 90%,transparent)}
    .ticker{display:flex; gap:20px; white-space:nowrap; animation:tick 28s linear infinite}
    @keyframes tick{from{transform:translateX(0)} to{transform:translateX(-50%)}}
    .pill{font-size:12px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08)}

    main{display:grid; grid-template-columns:360px 1fr; gap:16px; padding:16px; height:calc(100vh - 128px)}
    @media (max-width: 1024px){main{grid-template-columns:1fr; height:auto; overflow:auto}}

    .card{background:var(--panel); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:14px; backdrop-filter:blur(10px); box-shadow:var(--glow)}
    .stack{display:grid; gap:12px}
    .card h3{margin:6px 6px 8px; font-size:13px; text-transform:uppercase; letter-spacing:.12em; color:var(--muted)}

    .track{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border-radius:14px; background:linear-gradient(180deg,#1a1f38aa,#131a2faa); border:1px solid rgba(255,255,255,.06)}
    .meta{display:grid; gap:2px}
    .meta b{font-size:14px}
    .meta small{color:var(--muted)}

    .charts{display:grid; grid-template-rows:auto 1fr; gap:12px; min-height:360px; height:100%}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab{padding:10px 14px; border-radius:12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); font-weight:700; cursor:pointer}
    .tab.active{background:linear-gradient(135deg, rgba(124,77,255,.22), rgba(0,229,255,.18)); box-shadow:var(--glow)}
    .chart-wrap{position:relative; height:100%; min-height:340px; background:linear-gradient(180deg,#0f1322aa,#0a0d19aa); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:12px}

    footer{padding:10px 16px; display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:12px; color:var(--muted); background:linear-gradient(0deg, rgba(7,9,16,.75), rgba(7,9,16,.25)); border-top:1px solid rgba(255,255,255,.06)}
    code{background:rgba(255,255,255,.06); padding:2px 6px; border-radius:8px}
  </style>
</head>
<body>
  <!-- 3D reactive background -->
  <div id="bg"><canvas id="stage" class="webgl"></canvas></div>

  <div class="shell">
    <header>
      <div class="brand">
        <div class="dot"></div>
        <div>
          <b>Pulse<span style="color:var(--accent2)">Sphere</span></b><br>
          <small>Audio Visualizer Ã— Crypto Evolution</small>
        </div>
      </div>

      <div class="controls">
        <button id="playBtn" class="accent">â–¶ Play</button>
        <button id="nextBtn">â¤¿ Next</button>
        <label style="display:flex; align-items:center; gap:8px; padding:0 8px">
          <span style="font-size:12px;color:var(--muted)">Volume</span>
          <input id="vol" type="range" min="0" max="1" step="0.01" value="0.9">
        </label>
      </div>

      <div class="marquee" aria-label="Live prices">
        <div class="ticker" id="tickerA"></div>
        <div class="ticker" id="tickerB" style="position:absolute; left:50%"></div>
      </div>
    </header>

    <main>
      <aside class="card stack">
        <h3>Playlist</h3>
        <div id="playlist" class="stack"></div>
      </aside>

      <section class="card charts">
        <div class="tabs">
          <div class="tab active" data-coin="bitcoin">BTC</div>
          <div class="tab" data-coin="ethereum">ETH</div>
          <div class="tab" data-coin="solana">SOL</div>
        </div>
        <div class="chart-wrap"><canvas id="chart"></canvas></div>
      </section>
    </main>

    <footer>
      <div>ðŸŽ§ Put your files in <code>/audio/</code> (e.g. <code>music.mp3</code>, <code>music2.mp3</code>, <code>music3.mp3</code>). Visual reacts in real-time.</div>
      <div>ðŸ“ˆ Charts pull public data client-side (CoinGecko). Since 2021.</div>
    </footer>
  </div>

  <audio id="player" crossorigin="anonymous"></audio>

<script>
/*********************
 * AUDIO + PLAYLIST  *
 *********************/
const tracks = [
  { title: 'Track 1', file: 'https://probe-app.dreamweave.lol/audio/music.mp3' },
  { title: 'Track 2', file: '/audio/music2.mp3' },
  { title: 'Track 3', file: '/audio/music3.mp3' }
];
const audioEl = document.getElementById('player');
const playBtn = document.getElementById('playBtn');
const nextBtn = document.getElementById('nextBtn');
const vol = document.getElementById('vol');
const listEl = document.getElementById('playlist');

let actx, analyser, sourceNode, dataArray; // Web Audio
let currentIndex = 0; let isPlaying = false;

function renderPlaylist(){
  listEl.innerHTML = '';
  tracks.forEach((t,i)=>{
    const row = document.createElement('div');
    row.className = 'track';
    row.innerHTML = `<div class="meta"><b>${t.title}</b><small>${t.file}</small></div><button data-i="${i}">Play</button>`;
    row.querySelector('button').addEventListener('click',()=>startTrack(i));
    listEl.appendChild(row);
  })
}
renderPlaylist();

async function ensureAudioNodes(){
  if (!actx){
    actx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = actx.createAnalyser();
    analyser.fftSize = 1024; // 512 bins
    dataArray = new Uint8Array(analyser.frequencyBinCount);
  }
  if (!sourceNode){
    sourceNode = actx.createMediaElementSource(audioEl);
    sourceNode.connect(analyser);
    analyser.connect(actx.destination);
  }
}

function highlight(index){
  [...document.querySelectorAll('.track')].forEach((el,i)=>{
    const on = i===index;
    el.style.outline = on ? '2px solid rgba(0,229,255,.6)' : 'none';
    el.style.boxShadow = on ? '0 0 18px rgba(0,229,255,.25)' : 'none';
  })
}

async function startTrack(i){
  await ensureAudioNodes();
  currentIndex = i;
  audioEl.src = tracks[i].file;
  try{ await audioEl.play(); isPlaying = true; playBtn.textContent = 'â¸ Pause'; }catch(e){ console.warn(e); }
  highlight(i);
}

function nextTrack(){
  const prev = currentIndex; let pick = Math.floor(Math.random()*tracks.length);
  if(tracks.length>1){ while(pick===prev){ pick = Math.floor(Math.random()*tracks.length);} }
  startTrack(pick);
}

playBtn.addEventListener('click', async ()=>{
  await ensureAudioNodes();
  if(!isPlaying){ if(!audioEl.src) await startTrack(currentIndex); else { await audioEl.play(); isPlaying = true; playBtn.textContent='â¸ Pause'; } }
  else { audioEl.pause(); isPlaying = false; playBtn.textContent='â–¶ Play'; }
});
nextBtn.addEventListener('click', nextTrack);
vol.addEventListener('input', ()=> audioEl.volume = parseFloat(vol.value));

audioEl.addEventListener('ended', ()=>{ nextTrack(); });

/*********************
 * 3D VISUALIZER     *
 *********************/
const canvas = document.getElementById('stage');
const renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true});
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, 1, 0.1, 2000);
let W=innerWidth, H=innerHeight; camera.position.set(0, 18, 48);
renderer.setSize(W,H);

// Ring of bars + particle sphere
const group = new THREE.Group(); scene.add(group);
const bars = []; const BAR_COUNT = 128; const radius = 18;
const barGeo = new THREE.BoxGeometry(0.6,1,0.6);
const barMat = new THREE.MeshBasicMaterial({ color: 0x7c4dff, transparent:true, opacity:0.85 });
for(let i=0;i<BAR_COUNT;i++){
  const m = new THREE.Mesh(barGeo, barMat.clone());
  const a = (i/BAR_COUNT) * Math.PI*2; m.position.set(Math.cos(a)*radius, 0, Math.sin(a)*radius);
  m.lookAt(0,0,0); group.add(m); bars.push(m);
}

// Particle sphere
const pGeo = new THREE.BufferGeometry();
const P = 1500; const pos = new Float32Array(P*3);
for(let i=0;i<P;i++){
  const u = Math.random(); const v = Math.random();
  const theta = 2*Math.PI*u; const phi = Math.acos(2*v-1);
  const r = 22 + Math.random()*2;
  pos[i*3] = r*Math.sin(phi)*Math.cos(theta);
  pos[i*3+1] = r*Math.cos(phi);
  pos[i*3+2] = r*Math.sin(phi)*Math.sin(theta);
}
pGeo.setAttribute('position', new THREE.BufferAttribute(pos,3));
const pMat = new THREE.PointsMaterial({ size:0.08, color:0x00e5ff, transparent:true, opacity:0.9, depthWrite:false, blending:THREE.AdditiveBlending });
const stars = new THREE.Points(pGeo,pMat); scene.add(stars);

let hueShift = 0;
function animate(){
  requestAnimationFrame(animate);
  // frequency data -> bars
  if(analyser){ analyser.getByteFrequencyData(dataArray); }
  const t = performance.now()*0.001;
  let avg = 0;
  for(let i=0;i<bars.length;i++){
    let v = analyser ? dataArray[Math.floor(i*(dataArray.length/bars.length))] : (Math.sin(t*2+i*0.25)*0.5+0.5)*180;
    avg += v; const h = THREE.MathUtils.mapLinear(v, 0, 255, 0.8, 18.0);
    bars[i].scale.y = h; bars[i].material.opacity = THREE.MathUtils.mapLinear(v, 0, 255, .35, .95);
  }
  avg /= bars.length; hueShift = THREE.MathUtils.lerp(hueShift, avg/255, 0.06);
  const color = new THREE.Color().setHSL(0.65 - hueShift*0.25, 1.0, 0.6);
  bars.forEach(b=>b.material.color.copy(color));
  group.rotation.y += 0.002 + hueShift*0.01;
  stars.rotation.y -= 0.0006;
  renderer.render(scene,camera);
}
animate();

function onResize(){ W=innerWidth; H=innerHeight; camera.aspect=W/H; camera.updateProjectionMatrix(); renderer.setSize(W,H); }
addEventListener('resize', onResize);

/*********************
 * CRYPTO CHARTS     *
 *********************/
const ctx = document.getElementById('chart').getContext('2d');
const chart = new Chart(ctx, {
  type:'line',
  data:{ labels:[], datasets:[{ label:'Price (USD)', data:[], fill:true, tension:.25, pointRadius:0 }]},
  options:{ responsive:true, maintainAspectRatio:false, interaction:{mode:'index', intersect:false},
    plugins:{ legend:{labels:{color:'#cfe2ff'}}, tooltip:{callbacks:{label:(c)=>`$${c.formattedValue}`}} },
    scales:{ x:{ ticks:{color:'#cfe2ff'}, grid:{color:'rgba(255,255,255,.08)'}}, y:{ ticks:{color:'#cfe2ff'}, grid:{color:'rgba(255,255,255,.08)'} } }
  }
});

const COINS = ['bitcoin','ethereum','solana'];
const JAN2021 = new Date('2021-01-01T00:00:00Z').getTime();

async function fetchCoin(coin){
  const url = `https://api.coingecko.com/api/v3/coins/${coin}/market_chart?vs_currency=usd&days=max&interval=daily`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('API limit or network error');
  const j = await r.json(); // j.prices: [[ts, price], ...]
  const pts = j.prices.filter(p=>p[0]>=JAN2021);
  return {
    labels: pts.map(p=> new Date(p[0]).toISOString().slice(0,10) ),
    data: pts.map(p=> Number(p[1].toFixed(2)))
  }
}

async function loadChart(coin){
  setActiveTab(coin);
  try{
    const {labels,data} = await fetchCoin(coin);
    chart.data.labels = labels; chart.data.datasets[0].data = data; chart.data.datasets[0].label = `${coin.toUpperCase()} Price (USD)`; chart.update();
    // update ticker spot
    const last = data[data.length-1];
    updateTickerItem(coin.toUpperCase(), last);
  }catch(e){
    console.warn(e);
    // fallback synthetic data
    const labels = Array.from({length: 365*3}, (_,i)=>{
      const d = new Date(JAN2021 + i*86400000); return d.toISOString().slice(0,10);
    });
    const data = labels.map((_,i)=> 40000 + Math.sin(i*0.03)*8000 + Math.random()*4000 );
    chart.data.labels = labels; chart.data.datasets[0].data = data; chart.data.datasets[0].label = `${coin.toUpperCase()} (synthetic)`; chart.update();
    updateTickerItem(coin.toUpperCase(), data[data.length-1]);
  }
}

function setActiveTab(coin){
  document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.coin===coin));
}

document.querySelectorAll('.tab').forEach(t=> t.addEventListener('click', ()=> loadChart(t.dataset.coin)));
loadChart('bitcoin');

/*********************
 * TICKER             *
 *********************/
const tickerA = document.getElementById('tickerA');
const tickerB = document.getElementById('tickerB');
function formatUSD(n){ return `$${Number(n).toLocaleString(undefined,{maximumFractionDigits:2})}` }
function updateTickerItem(sym, price){
  const pill = `<span class="pill">${sym} <b>${formatUSD(price)}</b></span>`;
  const s = `${pill} <span class="pill">ETH â€” loadingâ€¦</span> <span class="pill">SOL â€” loadingâ€¦</span>`;
  if(!tickerA.innerHTML){ tickerA.innerHTML = s; tickerB.innerHTML = s; }
  // replace or append
  const html = tickerA.innerHTML;
  const re = new RegExp(`${sym} .*?</span>`);
  tickerA.innerHTML = html.replace(re, pill);
  tickerB.innerHTML = tickerA.innerHTML;
}
// prewarm with placeholders
updateTickerItem('BTC', 'â€”'); updateTickerItem('ETH','â€”'); updateTickerItem('SOL','â€”');
COINS.forEach(c=> loadChart(c)); // also fills ticker progressively

</script>
</body>
            </html>
            
