<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>probe-app | Quest Developer Tools</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/webadb@0.1.1/dist/webadb.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Orbitron:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles (matching probe-app) */
        :root {
            --primary-color: #6A1B9A;
            --secondary-color: #D81B60;
            --dark-text: #212121;
            --light-bg: #F3E5F5;
            --white: #FFFFFF;
            --black: #000000;
            --gray-light: #EEEEEE;
            --gray-medium: #757575;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --gradient-bg: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            color: var(--dark-text);
            font-family: 'Montserrat', sans-serif;
            overflow-x: hidden;
            background-color: var(--white);
        }

        /* Navigation (same as probe-app) */
        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 5%;
            background-color: var(--white);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
            position: relative;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--primary-color);
            text-decoration: none;
            letter-spacing: 1.5px;
        }

        .nav-logo-icon {
            height: 40px;
            width: auto;
            margin-right: 12px;
        }
        
        .auth-section {
            display: flex;
            align-items: center;
            position: relative;
        }

        .auth-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 22px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: 'Montserrat', sans-serif;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 12px rgba(106, 27, 154, 0.25);
        }

        .user-avatar {
            width: 46px;
            height: 46px;
            border-radius: 50%;
            cursor: pointer;
            object-fit: cover;
            border: 2px solid var(--primary-color);
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(106, 27, 154, 0.2);
            margin-left: 20px;
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            padding: 10px 20px;
            background-color: var(--light-bg);
            border-radius: 30px;
            margin: 20px 5%;
            font-weight: 600;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--error-color);
            margin-right: 10px;
        }

        .status-indicator.connected {
            background-color: var(--success-color);
        }

        /* Main Content */
        .dev-tools-container {
            padding: 20px 5%;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Settings Cards */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .settings-card {
            background-color: var(--white);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }

        .card-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-color);
            font-size: 1.2rem;
        }

        .setting-group {
            margin-bottom: 15px;
        }

        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        select, input[type="range"] {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
        }

        .range-value {
            display: inline-block;
            margin-left: 10px;
            font-size: 0.9rem;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        /* Terminal */
        .terminal-container {
            background-color: var(--white);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .terminal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .terminal-title {
            font-family: 'Orbitron', sans-serif;
            color: var(--primary-color);
        }

        .terminal-body {
            height: 300px;
            overflow-y: auto;
            background-color: #1E1E1E;
            color: #F0F0F0;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }

        .terminal-input {
            display: flex;
            gap: 10px;
        }

        .terminal-input input {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid var(--gray-light);
            border-radius: 30px;
        }

        .terminal-input button {
            border-radius: 30px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav>
        <a href="/" class="logo">
            <img src="https://i.ibb.co/Kxyq4qGh/Gemini-Generated-Image-uyuw4zuyuw4zuyuw-modified.png" alt="Probe App Logo" class="nav-logo-icon">
            <span>probe-app</span>
        </a>
        <div class="auth-section">
            <div class="notification-bell" id="notificationBell">
                <i class="fas fa-bell"></i>
                <span class="notification-badge" id="notificationBadge">0</span>
            </div>
            <button id="authButton" class="auth-btn">Sign In</button>
            <img id="userAvatar" class="user-avatar" src="" alt="User Avatar" style="display: none;">
        </div>

        <div id="userDropdown" class="user-dropdown">
            <div class="dropdown-item">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </div>
            <div class="dropdown-item">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
            <div class="dropdown-divider"></div>
            <div id="signOutBtn" class="dropdown-item">
                <i class="fas fa-sign-out-alt"></i>
                <span>Sign Out</span>
            </div>
        </div>
    </nav>

    <div class="connection-status" id="connectionStatus">
        <div class="status-indicator" id="statusIndicator"></div>
        <span id="statusText">Connect your Quest via USB with debugging enabled</span>
    </div>

    <div class="dev-tools-container" id="devTools">
        <div class="settings-grid">
            <!-- Display Settings -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-tv"></i> Display Settings
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Resolution</label>
                    <select id="resolutionSelect">
                        <option value="1832x1920">Default (1832x1920)</option>
                        <option value="2048x2176">High (2048x2176)</option>
                        <option value="2432x2688">Ultra (2432x2688)</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Refresh Rate</label>
                    <select id="refreshRateSelect">
                        <option value="72">72Hz</option>
                        <option value="80">80Hz</option>
                        <option value="90">90Hz</option>
                        <option value="120">120Hz (Experimental)</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Field of View</label>
                    <input type="range" id="fovSlider" min="70" max="110" value="90">
                    <span class="range-value" id="fovValue">90°</span>
                </div>
                <button class="btn" id="applyDisplayBtn">
                    <i class="fas fa-check"></i> Apply Display Settings
                </button>
            </div>

            <!-- Tracking Settings -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-hand-paper"></i> Tracking Settings
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Hand Tracking Mode</label>
                    <select id="handTrackingSelect">
                        <option value="off">Off</option>
                        <option value="controllers">Controllers Preferred</option>
                        <option value="hands">Hands Preferred</option>
                        <option value="auto">Auto</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">Tracking Frequency</label>
                    <select id="trackingFreqSelect">
                        <option value="60">Normal (60Hz)</option>
                        <option value="90">High (90Hz)</option>
                        <option value="120">Maximum (120Hz)</option>
                    </select>
                </div>
                <button class="btn" id="applyTrackingBtn">
                    <i class="fas fa-check"></i> Apply Tracking Settings
                </button>
            </div>

            <!-- Performance Settings -->
            <div class="settings-card">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-tachometer-alt"></i> Performance
                    </div>
                </div>
                <div class="setting-group">
                    <label class="setting-label">CPU Level</label>
                    <select id="cpuLevelSelect">
                        <option value="1">Level 1 (Conservative)</option>
                        <option value="2" selected>Level 2 (Default)</option>
                        <option value="3">Level 3 (High)</option>
                        <option value="4">Level 4 (Max)</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label class="setting-label">GPU Level</label>
                    <select id="gpuLevelSelect">
                        <option value="1">Level 1 (Conservative)</option>
                        <option value="2" selected>Level 2 (Default)</option>
                        <option value="3">Level 3 (High)</option>
                        <option value="4">Level 4 (Max)</option>
                    </select>
                </div>
                <button class="btn" id="applyPerformanceBtn">
                    <i class="fas fa-check"></i> Apply Performance Settings
                </button>
            </div>
        </div>

        <!-- ADB Terminal -->
        <div class="terminal-container">
            <div class="terminal-header">
                <div class="terminal-title">
                    <i class="fas fa-terminal"></i> ADB Terminal
                </div>
                <button class="btn" id="clearTerminalBtn">
                    <i class="fas fa-trash"></i> Clear
                </button>
            </div>
            <div class="terminal-body" id="terminalOutput">
                $ Waiting for device connection...
            </div>
            <div class="terminal-input">
                <input type="text" id="adbCommandInput" placeholder="Enter ADB command...">
                <button class="btn" id="sendAdbCommandBtn">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBMUi291fwb-HSxlGPQMxdEJGUTiOOvFBs",
            authDomain: "nexaverse-eeb07.firebaseapp.com",
            projectId: "nexaverse-eeb07",
            storageBucket: "nexaverse-eeb07.appspot.com",
            messagingSenderId: "686342300627",
            appId: "1:686342300627:web:90522d8f1129fb00b08526",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // WebADB Initialization
        const adb = new WebADB();
        let device = null;
        let adbClient = null;

        // DOM Elements
        const authButton = document.getElementById('authButton');
        const userAvatar = document.getElementById('userAvatar');
        const userDropdown = document.getElementById('userDropdown');
        const signOutBtn = document.getElementById('signOutBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const terminalOutput = document.getElementById('terminalOutput');
        const adbCommandInput = document.getElementById('adbCommandInput');
        const sendAdbCommandBtn = document.getElementById('sendAdbCommandBtn');
        const clearTerminalBtn = document.getElementById('clearTerminalBtn');
        const devTools = document.getElementById('devTools');
        const connectionStatus = document.getElementById('connectionStatus');

        // Append text to terminal
        function appendToTerminal(text) {
            terminalOutput.innerHTML += '\n' + text;
            terminalOutput.scrollTop = terminalOutput.scrollHeight;
        }

        // Clear terminal
        function clearTerminal() {
            terminalOutput.innerHTML = '$ Terminal cleared';
        }

        // Update connection status
        function updateConnectionStatus(connected, message = '') {
            if (connected) {
                statusIndicator.classList.add('connected');
                statusText.textContent = message || 'Connected to Quest (USB Debugging)';
                connectionStatus.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
            } else {
                statusIndicator.classList.remove('connected');
                statusText.textContent = message || 'Disconnected - Connect your Quest via USB with debugging enabled';
                connectionStatus.style.backgroundColor = 'rgba(244, 67, 54, 0.1)';
            }
        }

        // Connect to ADB device
        async function connectToDevice() {
            try {
                appendToTerminal('$ Attempting to connect to Quest...');
                
                // Request USB device access
                const usbDevice = await navigator.usb.requestDevice({
                    filters: [{ vendorId: 0x2833 }] // Meta/Oculus vendor ID
                });
                
                // Initialize ADB
                await adb.connect(usbDevice);
                device = usbDevice;
                adbClient = await adb.getClient(usbDevice);
                
                // Get device info
                const model = await adbClient.execOut('getprop ro.product.model');
                const serial = await adbClient.execOut('getprop ro.serialno');
                
                updateConnectionStatus(true, `Connected: ${model.trim()} [${serial.trim()}]`);
                appendToTerminal(`$ Successfully connected to ${model.trim()}`);
                
                // Start monitoring connection
                monitorConnection();
                
                return true;
            } catch (error) {
                console.error('Connection error:', error);
                updateConnectionStatus(false, 'Connection failed: ' + error.message);
                appendToTerminal('$ Connection error: ' + error.message);
                return false;
            }
        }

        // Monitor connection status
        async function monitorConnection() {
            try {
                while (device && adbClient) {
                    // Check connection by running a simple command
                    await adbClient.execOut('echo check');
                    await new Promise(resolve => setTimeout(resolve, 3000));
                }
            } catch (error) {
                console.log('Device disconnected');
                handleDisconnection();
            }
        }

        // Handle device disconnection
        function handleDisconnection() {
            device = null;
            adbClient = null;
            updateConnectionStatus(false, 'Device disconnected');
            appendToTerminal('$ Device disconnected');
        }

        // Execute ADB command
        async function executeAdbCommand(command) {
            if (!adbClient) {
                appendToTerminal('$ Error: No device connected');
                return;
            }

            try {
                appendToTerminal('$ ' + command);
                const output = await adbClient.execOut(command);
                if (output.trim()) {
                    appendToTerminal(output);
                }
            } catch (error) {
                appendToTerminal('$ Error: ' + error.message);
                
                // Check if device disconnected
                if (error.message.includes('disconnected')) {
                    handleDisconnection();
                }
            }
        }

        // Apply display settings
        async function applyDisplaySettings() {
            const resolution = document.getElementById('resolutionSelect').value;
            const refreshRate = document.getElementById('refreshRateSelect').value;
            const fov = document.getElementById('fovSlider').value;
            
            appendToTerminal('$ Applying display settings...');
            
            try {
                await executeAdbCommand(`settings put system display_resolution ${resolution}`);
                await executeAdbCommand(`settings put system display_refresh_rate ${refreshRate}`);
                appendToTerminal('$ Display settings applied successfully');
            } catch (error) {
                appendToTerminal('$ Failed to apply display settings: ' + error.message);
            }
        }

        // Event Listeners
        sendAdbCommandBtn.addEventListener('click', () => {
            const command = adbCommandInput.value.trim();
            if (command) {
                executeAdbCommand(command);
                adbCommandInput.value = '';
            }
        });

        adbCommandInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendAdbCommandBtn.click();
            }
        });

        clearTerminalBtn.addEventListener('click', clearTerminal);

        document.getElementById('applyDisplayBtn').addEventListener('click', applyDisplaySettings);
        
        document.getElementById('applyTrackingBtn').addEventListener('click', async () => {
            const mode = document.getElementById('handTrackingSelect').value;
            const freq = document.getElementById('trackingFreqSelect').value;
            
            appendToTerminal('$ Applying tracking settings...');
            await executeAdbCommand(`setprop debug.oculus.handTrackingMode ${mode}`);
            await executeAdbCommand(`setprop debug.oculus.trackingFrequency ${freq}`);
        });

        document.getElementById('applyPerformanceBtn').addEventListener('click', async () => {
            const cpu = document.getElementById('cpuLevelSelect').value;
            const gpu = document.getElementById('gpuLevelSelect').value;
            
            appendToTerminal('$ Applying performance settings...');
            await executeAdbCommand(`setprop debug.oculus.cpuLevel ${cpu}`);
            await executeAdbCommand(`setprop debug.oculus.gpuLevel ${gpu}`);
        });

        document.getElementById('fovSlider').addEventListener('input', (e) => {
            document.getElementById('fovValue').textContent = e.target.value + '°';
        });

        // Auth state listener
        auth.onAuthStateChanged(user => {
            if (user) {
                authButton.style.display = 'none';
                userAvatar.src = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || user.email}&background=6A1B9A&color=FFFFFF&bold=true`;
                userAvatar.style.display = 'block';
                
                // Try to connect when user logs in
                connectToDevice();
            } else {
                authButton.style.display = 'block';
                userAvatar.style.display = 'none';
            }
        });

        // Initialize
        updateConnectionStatus(false);
    </script>
</body>
</html>